# 🐍 贪吃蛇专业版 —— 前后端分离架构技术文档

## 1. 简介

本文档详细阐述了本贪吃蛇项目的**模块化前端架构**与**前后端分离设计**，涵盖核心游戏逻辑、数据持久化策略、实时排行榜系统等关键技术点。项目完整实现了单人、本地双人、人机对战三种模式，并通过 Spring Boot 后端支持**全服排行榜**功能，突破浏览器本地存储限制，实现跨设备、跨用户的全局竞技体验。

> **本地测试说明**  
> 项目采用前后端分离架构，请按以下步骤启动：
> 1. 启动后端：`cd backend && mvn spring-boot:run`（端口 `8080`）  
> 2. 启动前端：`npx http-server -p 5501`（端口 `5501`）  
> 3. 访问：`http://localhost:5501`  
> 4. **无需账号**：直接开始游戏，成绩自动同步至全服榜

---

## 2. 交付信息

| 项目             | 内容                                                         |
| :--------------- | :----------------------------------------------------------- |
| **交付项**       | 前端训练营 - 课程项目 - 贪吃蛇专业版                         |
| **产物地址**     | https://github.com/your-username/snake-pro.git               |
---

## 3. 实现的功能列表

### 3.1 基础与进阶功能（按课程要求）

| 要求类别       | 功能点                     | 实现情况                                                     |
| :------------- | :------------------------- | :----------------------------------------------------------- |
| **基础要求 1** | **工程环境与架构**         | **✔ 完成**。采用 **ES6 Modules + 分层架构**：<br> • **模块化前端**：<br> &emsp;- `entities/`：封装 `Snake`/`Food` 实体行为<br> &emsp;- `systems/`：解耦 `GameRenderer`/`GameMap` 系统功能<br> &emsp;- `config.js`：统一管理常量配置<br> • **现代工具链**：`http-server` 开发服务，零构建依赖 |
| **基础要求 2** | **核心游戏循环**           | **✔ 完成**。实现精准游戏逻辑：<br> • **移动与碰撞**：支持上下左右四方向，含首帧误判修复<br> • **食物系统**：3 种食物（苹果/香蕉/樱桃）共存，动态生成避障<br> • **多人模式**：本地双人（方向键 vs WASD）、人机对战（贪心 AI） |
| **基础要求 3** | **UI 与状态管理**          | **✔ 完成**。提供完整用户界面：<br> • **动态难度**：3 档速度（5/8/12 格/秒）实时切换<br> • **游戏状态**：开始/暂停/结束/恢复四态管理<br> • **动效体验**：分数飘字（CSS 缓动）、按钮 hover 抬升 |
| **基础要求 4** | **本地数据持久化**         | **✔ 完成**。利用浏览器存储：<br> • **最高分**：`localStorage` 保存历史最佳<br> • **游戏恢复**：刷新后可续玩未结束对局<br> • **本地排行榜**：Top 10 成绩按分数/时间排序 |
| **进阶功能 1** | **在线排行榜（前后端分离）** | **✔ 完成**。通过 Spring Boot 实现全服竞争：<br> • **自动同步**：游戏结束自动上传成绩<br> • **双榜共存**：本地榜（浏览器隔离） + 在线榜（全局共享）<br> • **降级策略**：网络失败时自动回退本地存储 |
| **进阶功能 3** | **音效与沉浸体验**         | **✔ 完成**。增强游戏反馈：<br> • **BGM 系统**：背景音乐循环播放 + 音量控制<br> • **关键音效**：吃食物、游戏结束音效<br> • **预加载优化**：`<audio>` 标签避免首播延迟 |
| **进阶功能 6** | **对象池性能优化**         | **✔ 完成**。提升高频操作性能：<br> • **分数飘字复用**：`SpritePool` 管理 DOM 配置对象<br> • **内存管控**：减少 GC 压力，连吃 50 次仍 60fps |

---

## 4. 架构与关键设计思路

### 4.1 整体架构：前后端分离 + 前端模块化

本项目采用**双轨数据流**设计，兼顾离线体验与在线竞争：

#### ▶ 前端 (Browser) —— 独立运行的核心引擎
- **Canvas 渲染核心**  
  使用 HTML5 Canvas 实现游戏主画面（蛇、食物、网格），性能稳定，60fps 流畅。
- **localStorage 数据持久化**  
  - `snakeHighScore`：存储当前浏览器用户的最高分  
  - `snakeSavedState`：保存未结束的游戏进度，刷新后可恢复  
  - `snakeLeaderboard`：本地 Top 10 成绩（按分数/时间排序）
- **在线交互接口**  
  - `GET /ranklist/get/`：获取全服排行榜（显示在右侧“🌐 在线排行榜”区域）  
  - `POST /ranklist/update/`：提交当前成绩到后端（游戏结束时自动触发）

#### ▶ 后端 (Server) —— 轻量级数据服务
- **Spring Boot 应用**  
  提供 RESTful API 接口，无用户系统、无鉴权，部署简单。
- **MySQL 数据库**  
  表 `rankinfo` 存储所有玩家成绩，字段包括：
  - `id`：自增主键  
  - `score`：整数，记录得分  
  - `date`：长整型，记录时间戳（毫秒）  
  → 通过 `ORDER BY score DESC, date ASC` 实现公平排名
- **关键 API**  
  - `POST /ranklist/update/`：接收前端提交的成绩  
  - `GET /ranklist/get/`：返回全服 Top 10 数据（格式：`{ "status": "success", "data": [ { "score": 200 }, ... ] }`）

#### ▶ 前后端通信机制
- **协议**：HTTP/JSON（无 WebSocket，满足轻量需求）
- **通信方向**：
  - 前端 → 后端：提交成绩（POST）  
  - 前端 ← 后端：拉取榜单（GET）
- **容错设计**：
  - 网络失败 → 自动降级至本地榜（静默处理，用户无感知）  
  - 后端异常 → 前端捕获并提示“加载失败，仅显示本地榜”

---

> ✅ **架构优势总结**
> - **离线优先**：无需网络即可完整游玩，本地数据持久化保障体验  
> - **在线扩展**：成绩自动同步至全服，实现跨设备竞争  
> - **维护简单**：后端仅需两个 API，无复杂业务逻辑  
> - **性能卓越**：前端对象池优化 + Canvas 渲染，低端设备流畅运行

#### 系统分层架构

- **表现层 (Presentation Layer)**  
  由 `index.html` + `style.css` 组成，负责 UI 构建与事件捕获：
  - 主游戏区：Canvas 渲染蛇/食物/网格
  - 控制面板：难度/模式选择、状态按钮
  - 排行榜区：本地榜（左侧） + 在线榜（右侧）

- **业务逻辑与控制层 (Business Logic & Control Layer)**  
  采用 **MVC 思想**，由 `Game.js` 主控制器协调各模块：
  - `entities/`：`Snake.js`/`Food.js` 封装实体行为
  - `systems/`：`GameRenderer.js`/`GameMap.js` 提供系统能力
  - `GameStateManager.js`：统一管理存档/恢复

- **网络通信层 (Network Layer)**  
  通过标准 HTTP 实现数据同步：
  - **提交通道**：`POST /ranklist/update/` 上传成绩
  - **拉取通道**：`GET /ranklist/get/` 获取全服榜

- **数据持久层 (Data Persistence Layer)**  
  双轨存储策略：
  - **前端**：`localStorage` 存储本地数据（浏览器隔离）
  - **后端**：MySQL `rankinfo` 表存储全服数据（全局共享）

### 4.2 关键设计思路

| 设计点                 | 实现方式                                                     | 带来的优势                                                   |
| :--------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| **前后端分离架构**     | 后端基于 **Spring Boot** 提供 RESTful API；前端通过 `fetch()` 异步调用。 | **解耦**：前端专注游戏逻辑，后端专注数据管理。<br>**扩展性**：同一 API 可支持 Web/小程序多端。<br>**轻量**：无登录要求，开箱即用。 |
| **双轨数据持久化**     | 本地：`localStorage`；远程：MySQL 数据库；通过自动降级机制协同。 | **离线可用**：网络中断时仍可游玩并记录本地成绩。<br>**全局竞争**：所有用户成绩汇总，实现真正全服排名。 |
| **前端模块化分层**     | 按职责拆分为 `entities/`、`systems/`、`config.js` 等独立模块。 | **高内聚低耦合**：每个文件只负责单一功能。<br>**易测试**：可单独验证 `Snake.move()` 等核心逻辑。<br>**易维护**：新增功能只需添加新模块。 |
| **对象池性能优化**     | `SpritePool.js` 管理分数飘字配置对象，避免高频 DOM 创建/销毁。 | **流畅体验**：连吃 50 次仍稳定 60fps。<br>**内存友好**：减少 GC 压力，低端设备无卡顿。 |
| **AI 安全决策链**      | 合法方向 → 任意合法方向 → 任意方向 三级 fallback 机制。     | **永不卡死**：AI 在极端情况下仍能移动。<br>**行为合理**：优先寻食避障，符合“简易AI”要求。 |

---

## 5. 遇到的挑战与解决方案

| 问题描述                                                     | 根本原因                                                     | 解决方案                                                     |
| :----------------------------------------------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| **1. 首帧碰撞误判**                                          | 蛇初始生成时身体相邻，`frameCount=0` 时误判自撞。            | **时序隔离**：引入 `frameCount` 变量，首帧跳过碰撞检测。    |
| **2. 在线榜刷新后不显示**                                    | 在线榜初始化晚于页面渲染，需手动触发。                       | **主动加载**：`constructor()` 末尾调用 `this.loadOnlineLeaderboard()`。 |
| **3. CORS 跨域问题**                                         | 前端 `5501` 端口与后端 `8080` 端口被视为不同源。             | **双保险**：<br>• 后端配置 `spring.web.cors.allowed-origins`<br>• 前端使用绝对路径 `http://localhost:8080/...` |
| **4. Shift 键触发页面刷新**                                  | 浏览器默认将 `Shift+Enter` 解释为表单提交。                 | **事件拦截**：全局 `keydown` 监听器中 `e.preventDefault()`。 |

---

## 🚀 项目亮点总结

- **真正的全服竞争**：突破浏览器限制，实现跨设备成绩同步  
- **零门槛体验**：无需注册/登录，开箱即用  
- **专业级架构**：模块化前端 + Spring Boot 后端，生产级代码质量  
- **极致性能**：对象池优化 + Canvas 渲染，低端设备流畅运行  
